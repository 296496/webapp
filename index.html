<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-purple': '#4F46E5', // Indigo-600 for primary
                        'primary-green': '#6EE7B7', // Emerald-300 for logging
                        'light-gray': '#E5E7EB',
                        'dark-text': '#1F2937',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        /* Custom styles for the large display */
        .stopwatch-display {
            font-size: clamp(3rem, 10vw, 6rem);
            font-weight: 700;
            letter-spacing: -2px;
            font-family: 'Inter', sans-serif;
            line-height: 1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-12 px-4 font-sans text-dark-text">

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-3xl font-bold mb-1">Time Tracker</h1>
            <p class="text-gray-500">Measure, Name, and Log Your Activities</p>
        </header>

        <!-- Main Stopwatch Card -->
        <div id="stopwatch-card" class="bg-white p-6 md:p-8 rounded-xl shadow-2xl mb-10 border border-primary-purple/30">
            <h2 class="text-xl font-semibold mb-6">Stopwatch</h2>

            <!-- Time Display -->
            <div class="bg-gray-50 p-6 rounded-lg mb-6 text-center shadow-inner">
                <div id="time-display" class="stopwatch-display text-dark-text">00:00:00.000</div>
            </div>

            <!-- Controls -->
            <div class="flex items-center justify-center space-x-4 mb-8">
                <button id="start-stop-btn"
                    class="px-6 py-3 rounded-xl font-medium text-white shadow-lg shadow-primary-purple/40 transition duration-150 ease-in-out bg-primary-purple hover:bg-indigo-700">
                    Start
                </button>
                <button id="reset-btn"
                    class="px-6 py-3 rounded-xl font-medium text-gray-700 bg-light-gray hover:bg-gray-300 transition duration-150 ease-in-out">
                    Reset
                </button>
            </div>

            <!-- Logging Section -->
            <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 pt-4 border-t border-gray-100">
                <input type="text" id="activity-name-input" placeholder="fun"
                    class="flex-grow w-full sm:w-auto px-4 py-3 border border-gray-300 rounded-xl focus:ring-primary-purple focus:border-primary-purple transition duration-150"
                    value="Activity">
                <button id="log-time-btn"
                    class="w-full sm:w-auto px-6 py-3 rounded-xl font-medium text-dark-text bg-primary-green hover:bg-emerald-400 shadow-md shadow-primary-green/40 transition duration-150 ease-in-out disabled:opacity-50"
                    disabled>
                    Log Time & Reset
                </button>
            </div>
        </div>

        <!-- Activity Log Card -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl">
            <h2 class="text-xl font-semibold mb-6">Activity Log Sheet</h2>

            <!-- User ID Display -->
            <div class="text-sm text-gray-500 mb-4 flex justify-between items-center">
                <span>Data stored privately for user:</span>
                <span id="user-id-display" class="font-mono bg-gray-100 px-3 py-1 rounded text-xs text-primary-purple break-all">...loading user...</span>
            </div>

            <!-- Log Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr class="text-left bg-gray-50">
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Activity Name</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                            <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Logged At</th>
                        </tr>
                    </thead>
                    <tbody id="activity-log-body" class="bg-white divide-y divide-gray-100">
                        <!-- Log entries will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <!-- Empty state message -->
            <div id="empty-log-message" class="text-center py-10 text-gray-400 italic">
                No activities logged yet. Start tracking!
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging
        setLogLevel('Debug');

        // --- GLOBAL FIREBASE/APP SETUP ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let currentUserId = null;
        let isAuthReady = false;

        const timeDisplay = document.getElementById('time-display');
        const startStopBtn = document.getElementById('start-stop-btn');
        const resetBtn = document.getElementById('reset-btn');
        const logTimeBtn = document.getElementById('log-time-btn');
        const activityInput = document.getElementById('activity-name-input');
        const logBody = document.getElementById('activity-log-body');
        const emptyMessage = document.getElementById('empty-log-message');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- STOPWATCH STATE ---
        let startTime = 0;
        let elapsedTime = 0;
        let timerInterval = null;
        let isRunning = false;

        /**
         * Formats milliseconds into HH:MM:SS.mmm string.
         * @param {number} ms - time in milliseconds.
         * @returns {string} Formatted time string.
         */
        function formatTime(ms) {
            const date = new Date(ms);
            const hours = String(date.getUTCHours()).padStart(2, '0');
            const minutes = String(date.getUTCMinutes()).padStart(2, '0');
            const seconds = String(date.getUTCSeconds()).padStart(2, '0');
            const milliseconds = String(date.getUTCMilliseconds()).padStart(3, '0');
            return `${hours}:${minutes}:${seconds}.${milliseconds}`;
        }

        /**
         * Updates the stopwatch display.
         */
        function updateDisplay() {
            const currentTime = isRunning ? Date.now() : 0;
            const timeDiff = currentTime - startTime;
            const currentElapsedTime = isRunning ? elapsedTime + timeDiff : elapsedTime;
            timeDisplay.textContent = formatTime(currentElapsedTime);
            // Enable/disable log button based on elapsed time
            logTimeBtn.disabled = currentElapsedTime < 1000 || !isAuthReady; // Require at least 1 second logged
        }

        /**
         * Starts or stops the stopwatch.
         */
        function startStop() {
            if (isRunning) {
                // STOP
                clearInterval(timerInterval);
                elapsedTime += Date.now() - startTime;
                isRunning = false;
                startStopBtn.textContent = 'Start';
                startStopBtn.classList.replace('bg-indigo-700', 'bg-primary-purple');
                startStopBtn.classList.replace('shadow-red-500/40', 'shadow-primary-purple/40');
            } else {
                // START
                startTime = Date.now();
                timerInterval = setInterval(updateDisplay, 10);
                isRunning = true;
                startStopBtn.textContent = 'Stop';
                startStopBtn.classList.replace('bg-primary-purple', 'bg-indigo-700');
                startStopBtn.classList.replace('shadow-primary-purple/40', 'shadow-red-500/40');
            }
            updateDisplay();
        }

        /**
         * Resets the stopwatch completely.
         */
        function reset() {
            if (isRunning) {
                startStop(); // Stop first
            }
            startTime = 0;
            elapsedTime = 0;
            updateDisplay();
        }

        /**
         * Logs the current time and resets the stopwatch.
         */
        async function logTimeAndReset() {
            if (!isAuthReady || !currentUserId) {
                console.error("Cannot log: User not authenticated.");
                // Show a user-friendly message instead of alert
                timeDisplay.textContent = "Error: Authentication required to log.";
                return;
            }

            const activityName = activityInput.value.trim() || 'Unnamed Activity';
            if (isRunning) {
                startStop(); // Stop the timer before logging
            }
            
            const finalElapsedTime = elapsedTime;

            if (finalElapsedTime === 0) {
                // Use custom message instead of alert
                console.log("Cannot log: Timer is at 0.");
                return;
            }

            const durationFormatted = formatTime(finalElapsedTime);

            const newActivity = {
                name: activityName,
                durationMs: finalElapsedTime,
                duration: durationFormatted,
                loggedAt: serverTimestamp(),
                userId: currentUserId,
            };

            // Save to Firestore
            try {
                const collectionPath = `artifacts/${appId}/users/${currentUserId}/activities`;
                await addDoc(collection(db, collectionPath), newActivity);
                console.log("Activity successfully logged to Firestore.");
                activityInput.value = 'Activity'; // Reset input
                reset(); // Reset stopwatch state
            } catch (e) {
                console.error("Error adding document: ", e);
                timeDisplay.textContent = "Error logging activity. Check console.";
            }
        }

        /**
         * Renders the activity log from the Firestore data.
         * @param {Array<Object>} activities - Array of activity objects.
         */
        function renderActivities(activities) {
            logBody.innerHTML = '';
            if (activities.length === 0) {
                emptyMessage.classList.remove('hidden');
                return;
            }
            emptyMessage.classList.add('hidden');

            // Sort activities by loggedAt descending (newest first)
            activities.sort((a, b) => (b.loggedAt?.toMillis() || 0) - (a.loggedAt?.toMillis() || 0));

            activities.forEach(activity => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';

                // Format timestamp
                let loggedTime = 'Logging...';
                if (activity.loggedAt && typeof activity.loggedAt.toDate === 'function') {
                    loggedTime = activity.loggedAt.toDate().toLocaleTimeString('en-US', {
                        hour: '2-digit', minute: '2-digit', second: '2-digit',
                    });
                } else if (activity.loggedAt) {
                    // Fallback for non-Timestamp objects (shouldn't happen with serverTimestamp)
                    loggedTime = new Date(activity.loggedAt).toLocaleTimeString('en-US', {
                        hour: '2-digit', minute: '2-digit', second: '2-digit',
                    });
                }


                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-dark-text">${activity.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${activity.duration}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${loggedTime}</td>
                `;
                logBody.appendChild(tr);
            });
        }


        /**
         * Sets up the real-time listener for the user's activities.
         */
        function setupRealtimeListener(db, userId, appId) {
            if (!userId) return;

            const collectionPath = `artifacts/${appId}/users/${userId}/activities`;
            const activitiesRef = collection(db, collectionPath);
            const q = query(activitiesRef);

            onSnapshot(q, (snapshot) => {
                const activities = [];
                snapshot.forEach((doc) => {
                    activities.push({ id: doc.id, ...doc.data() });
                });
                renderActivities(activities);
            }, (error) => {
                console.error("Error listening to activities:", error);
            });
        }


        // --- EVENT LISTENERS ---
        startStopBtn.addEventListener('click', startStop);
        resetBtn.addEventListener('click', reset);
        logTimeBtn.addEventListener('click', logTimeAndReset);

        // --- INITIALIZATION ---
        window.onload = function() {
            try {
                // 1. Initialize Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Auth State Listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = currentUserId;
                        isAuthReady = true;
                        // Start listening for data now that we have a user ID
                        setupRealtimeListener(db, currentUserId, appId);
                        console.log("Firebase initialized and user ready:", currentUserId);
                    } else {
                        // Attempt to sign in if not already signed in
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                                console.error("Custom token sign-in failed, falling back to anonymous:", e);
                                signInAnonymously(auth);
                            });
                        } else {
                            // If no token, sign in anonymously
                            await signInAnonymously(auth);
                        }
                    }
                });

                // Call updateDisplay once to ensure the initial button states are correct
                updateDisplay();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                userIdDisplay.textContent = "Error: Check console";
            }
        };